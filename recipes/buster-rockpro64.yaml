architecture: arm64

actions:
{{ if .extract }}
  - action: unpack
    file: rootfs.tar.gz
{{ else }}
  - action: debootstrap
    suite: buster
    components:
      - main
      - contrib
      - non-free
    mirror: https://deb.debian.org/debian

  - action: pack
    file: rootfs.tar.gz
    compression: gz
{{ end }}
  - action: apt
    packages:
      - curl
      - dbus
      - default-dbus-session-bus
      - file
      - gdisk
      - gnupg
      - initramfs-tools
      - locales
      - man-db
      - openssh-server
      - parted
      - sudo
      - u-boot-menu
      - vim
      - wget

  - action: run
    chroot: true
    command: echo RESUME=none > /etc/initramfs-tools/conf.d/resume

  - action: overlay
    source: ../overlays/u-boot-menu

  - action: overlay
    source: ../overlays/openssh

  - action: run
    chroot: true
    script: ../scripts/setup-openssh.sh

  - action: overlay
    source: ../overlays/apt-repo

  - action: run
    chroot: true
    script: ../scripts/apt-repo.sh

  - action: apt
    packages:
      - linux-image-{{ .kernel_version }}

  - action: run
    chroot: true
    script: ../scripts/setup-user.sh

  - action: run
    chroot: true
    command: echo rockpro64 > /etc/hostname

  - action: overlay
    source: ../overlays/networkd

  - action: run
    chroot: true
    script: ../scripts/setup-networking.sh

  - action: image-partition
    description: Partition according to Rockchip's partition format
    imagename: debian-rockpro64.img
    imagesize: 1GB
    partitiontype: gpt
    mountpoints:
      - mountpoint: /
        partition: root
    partitions:
      - name: loader1
        fs: none
        start: 64s
        end: 8063s
      - name: reserved1
        fs: none
        start: 8064s
        end: 8191s
      - name: reserved2
        fs: none
        start: 8192s
        end: 16383s
      - name: loader2
        fs: none
        start: 16384s
        end: 24575s
      - name: atf
        fs: none
        start: 24576s
        end: 32767s
      - name: boot
        fs: vfat
        start: 32768s
        end: 262143s
        flags:
          - esp
      - name: root
        fs: ext4
        start: 262144s
        end: 100%
        flags:
          - legacy_boot

  - action: run
    chroot: true
    command: cat /etc/fstab

  - action: run
    chroot: true
    command: cat /etc/kernel/cmdline

  - action: run
    chroot: true
    command: /usr/sbin/u-boot-update

  - action: run
    chroot: true
    script: ../scripts/setup-resolvconf.sh

  - action: filesystem-deploy
    description: Deploying filesystem onto image

  - action: raw
    origin: artifacts
    source: idbloader.img
    partition: loader1
    offset: 0

  - action: raw
    origin: artifacts
    source: u-boot.itb
    partition: loader2
    offset: 0
